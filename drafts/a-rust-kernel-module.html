<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>A Rust Kernel Module</title>
        <link rel="stylesheet" href="https://blog.rnstlr.ch/theme/css/main.css" />
        <link href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.rnstlr.ch Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.rnstlr.ch/">blog.rnstlr.ch </a></h1>
                <nav><ul>
                    <li><a href="https://blog.rnstlr.ch/category/2013.html">2013</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2015.html">2015</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2016.html">2016</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2017.html">2017</a></li>
                    <li class="active"><a href="https://blog.rnstlr.ch/category/2022.html">2022</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.rnstlr.ch/drafts/a-rust-kernel-module.html" rel="bookmark"
           title="Permalink to A Rust Kernel Module">A Rust Kernel Module</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-12-18T00:00:00+01:00">
                Published: So 18 Dezember 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.rnstlr.ch/author/rnestler.html">rnestler</a>
        </address>
<p>In <a href="https://blog.rnstlr.ch/category/2022.html">2022</a>.</p>
<p>tags: <a href="https://blog.rnstlr.ch/tag/rust.html">rust</a> <a href="https://blog.rnstlr.ch/tag/kernel.html">kernel</a> </p>
</footer><!-- /.post-info -->      <h1>A Rust Kernel Module</h1>
<p>With the release of <a href="https://lwn.net/Articles/917504/">Linux 6.1</a> minimal Rust
support landed and it should be possible to easily build a hello world kernel
module in Rust.</p>
<h2>Installing Linux 6.1</h2>
<p>At the time of writing Linux 6.1 was still in testing on ArchLinux, so I
enabled the testing repositories:</p>
<div class="highlight"><pre><span></span><code><span class="gd">--- pacman.conf 2022-12-18 15:25:10.742819293 +0100</span><span class="w"></span>
<span class="gi">+++ /etc/pacman.conf    2022-12-18 00:32:56.404801925 +0100</span><span class="w"></span>
<span class="gu">@@ -69,8 +69,8 @@</span><span class="w"></span>
<span class="w"> </span># repo name header and Include lines. You can add preferred servers immediately<span class="w"></span>
<span class="w"> </span># after the header, and they will be used before the default mirrors.<span class="w"></span>

<span class="gd">-#[testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[core]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
<span class="gu">@@ -78,8 +78,8 @@</span><span class="w"></span>
<span class="w"> </span>[extra]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>

<span class="gd">-#[community-testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[community-testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[community]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
<span class="gu">@@ -87,8 +87,8 @@</span><span class="w"></span>
<span class="w"> </span># If you want to run 32 bit applications on your x86_64 system,<span class="w"></span>
<span class="w"> </span># enable the multilib repositories as required here.<span class="w"></span>

<span class="gd">-#[multilib-testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[multilib-testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[multilib]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
</code></pre></div>

<h2>A first start</h2>
<p>Since I just want to play around I decided to build an out-of-tree Rust module.
Luckily there is an example module available for that already:
https://github.com/Rust-for-Linux/rust-out-of-tree-module.</p>
<p>So I went ahead, cloned the repo and tried to just execute make:</p>
<div class="highlight"><pre><span></span><code><span class="n">rust</span><span class="o">-</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">tree</span><span class="o">-</span><span class="k">module</span><span class="w"> </span><span class="p">(</span><span class="n">git</span><span class="p">)</span><span class="o">-[</span><span class="n">main</span><span class="o">]</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">make</span><span class="w"></span>
<span class="n">make</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="err">`</span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="err">`</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">M</span><span class="o">=</span><span class="err">$</span><span class="n">PWD</span><span class="w"></span>
<span class="n">make</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">Entering</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/usr/lib/modules/6.1.0-arch1-1/build&#39;</span><span class="w"></span>
<span class="w">  </span><span class="n">RUSTC</span><span class="w"> </span><span class="o">[</span><span class="n">M</span><span class="o">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">roughl</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">Linux</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">tree</span><span class="o">-</span><span class="k">module</span><span class="o">/</span><span class="n">rust_out_of_tree</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="nl">error</span><span class="p">:</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="ss">&quot;./rust/target.json&quot;</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">exist</span><span class="w"></span>

<span class="n">make</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="o">[</span><span class="n">scripts/Makefile.build:307: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o</span><span class="o">]</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">make</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="o">[</span><span class="n">Makefile:1992: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module</span><span class="o">]</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">make</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">Leaving</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/usr/lib/modules/6.1.0-arch1-1/build&#39;</span><span class="w"></span>
<span class="nl">make</span><span class="p">:</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="o">[</span><span class="n">Makefile:6: default</span><span class="o">]</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</code></pre></div>

<p>Well...</p>
<p>Reading through
https://www.kernel.org/doc/html/latest/rust/quick-start.html
it seemed that I have everything I need to get started.</p>
<h2>Trying an in-kernel build</h2>
<p>To check if it is just a tooling issue I cloned the
https://github.com/Rust-for-Linux/linux repo and executed the check according
to the documentation:</p>
<div class="highlight"><pre><span></span><code><span class="n">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">Linux</span><span class="o">/</span><span class="n">linux</span><span class="w"> </span><span class="p">(</span><span class="n">git</span><span class="p">)</span><span class="o">-[</span><span class="n">rust</span><span class="o">]</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">LLVM</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">rustavailable</span><span class="w"></span>
<span class="o">***</span><span class="w"></span>
<span class="o">***</span><span class="w"> </span><span class="n">Rust</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="s1">&#39;rustc&#39;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="w"></span>
<span class="o">***</span><span class="w">   </span><span class="n">Your</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w">     </span><span class="mf">1.66.0</span><span class="w"></span>
<span class="o">***</span><span class="w">   </span><span class="n">Expected</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w"> </span><span class="mf">1.62.0</span><span class="w"></span>
<span class="o">***</span><span class="w"></span>
<span class="o">***</span><span class="w"></span>
<span class="o">***</span><span class="w"> </span><span class="n">Rust</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="s1">&#39;bindgen&#39;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="w"></span>
<span class="o">***</span><span class="w">   </span><span class="n">Your</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w">     </span><span class="mf">0.63.0</span><span class="w"></span>
<span class="o">***</span><span class="w">   </span><span class="n">Expected</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w"> </span><span class="mf">0.56.0</span><span class="w"></span>
<span class="o">***</span><span class="w"></span>
<span class="n">Rust</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">available</span><span class="err">!</span><span class="w"></span>
</code></pre></div>

<p>Since my toolchain seems to new I installed the older versions with</p>
<div class="highlight"><pre><span></span><code><span class="n">rustup</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="p">(</span><span class="n">scripts</span><span class="o">/</span><span class="nb">min</span><span class="o">-</span><span class="k">tool</span><span class="o">-</span><span class="n">version</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">rustc</span><span class="p">)</span><span class="w"></span>
<span class="n">rustup</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">rust</span><span class="o">-</span><span class="n">src</span><span class="w"></span>
<span class="n">cargo</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">locked</span><span class="w"> </span><span class="o">--</span><span class="n">version</span><span class="w"> </span><span class="o">$</span><span class="p">(</span><span class="n">scripts</span><span class="o">/</span><span class="nb">min</span><span class="o">-</span><span class="k">tool</span><span class="o">-</span><span class="n">version</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">bindgen</span><span class="p">)</span><span class="w"> </span><span class="n">bindgen</span><span class="w"></span>
</code></pre></div>

<p>Then I enabled Rust support with <code>make menuconfig</code> in the <em>General setup</em> menu.
The option is only shown if the toolchain is installed and in my case I also
had to disable the <code>GCC_PLUGINS</code> option.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.coredump.ch/">coredump</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/rnstlr">twitter</a></li>
                            <li><a href="https://github.com/rnestler">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>